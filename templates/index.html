<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InduSoft - Controle de Qualidade</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts (Roboto para ar industrial/técnico) -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- CSS Personalizado -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</head>
<body>

<div class="d-flex" id="wrapper">
    <!-- Sidebar -->
    <div id="sidebar-wrapper">
        <div class="sidebar-heading">
            <i class="fas fa-industry"></i> INDUSOFT
        </div>
        <div class="list-group list-group-flush">
            <a href="#" class="list-group-item list-group-item-action active">
                <i class="fas fa-vial me-2"></i> Controle de Qualidade
            </a>
            <!-- Placeholder para módulos futuros -->
            <a href="#" class="list-group-item list-group-item-action">
                <i class="fas fa-boxes me-2"></i> Estoque de MP
            </a>
            <a href="#" class="list-group-item list-group-item-action">
                <i class="fas fa-cogs me-2"></i> Configurações
            </a>
        </div>
    </div>
    <!-- /#sidebar-wrapper -->

    <!-- Page Content -->
    <div id="page-content-wrapper">
        <!-- Top Navbar -->
        <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
            <div class="container-fluid">
                <button class="btn btn-outline-secondary" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>

                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <form class="d-flex ms-auto me-3">
                        <input class="form-control me-2" type="search" placeholder="Buscar lote ou material..." aria-label="Search">
                        <button class="btn btn-outline-primary" type="submit">Buscar</button>
                    </form>
                    <ul class="navbar-nav mt-2 mt-lg-0">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <i class="fas fa-user-circle fa-lg me-1"></i> Eng. Responsável
                            </a>
                            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                                <a class="dropdown-item" href="#">Perfil</a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item text-danger" href="#">Sair</a>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container-fluid px-4 py-4">
            
            <div class="row mb-3">
                <div class="col-12">
                    <h2 class="fs-4 mb-0 text-secondary">Dashboard de Análise de Lotes</h2>
                    <p class="text-muted small">Visão geral dos ensaios reométricos e decisões de qualidade.</p>
                </div>
            </div>

            <!-- KPI Cards -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="card p-3 border-start border-4 border-primary">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="kpi-label">Total Ensaios</div>
                                <div class="kpi-value text-dark">{{ kpi.total }}</div>
                            </div>
                            <i class="fas fa-clipboard-list fa-2x text-black-50"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3 border-start border-4 border-success">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="kpi-label">Aprovados (Prime)</div>
                                <div class="kpi-value text-success">{{ kpi.aprovados }}</div>
                            </div>
                            <i class="fas fa-check-circle fa-2x text-success opacity-50"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3 border-start border-4 border-warning">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="kpi-label">Com Ressalva/Cortar e Misturar</div>
                                <div class="kpi-value text-warning">{{ kpi.ressalvas }}</div>
                            </div>
                            <i class="fas fa-exclamation-circle fa-2x text-warning opacity-50"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3 border-start border-4 border-danger">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="kpi-label">Reprovados</div>
                                <div class="kpi-value text-danger">{{ kpi.reprovados }}</div>
                            </div>
                            <i class="fas fa-times-circle fa-2x text-danger opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="card mb-4 p-3">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">Data Início</label>
                        <input type="date" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">Data Fim</label>
                        <input type="date" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold">Material / Família</label>
                        <select class="form-select">
                            <option selected>Todos os Materiais</option>
                            <option>NBR-70 (Nitrílica)</option>
                            <option>EPDM-40</option>
                            <option>FKM-Viton</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100"><i class="fas fa-filter me-1"></i> Filtrar</button>
                    </div>
                </div>
            </div>

            <!-- Tabela de Dados -->
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead>
                        <tr>
                            <th>ID Ensaio</th>
                            <th>Material</th>
                            <th>Lote / Batch</th>
                            <th>Viscosidade (ML 1+4)</th>
                            <th style="width: 20%;">Quality Score</th>
                            <th>Ação Recomendada</th>
                            <th class="text-center">Detalhes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ensaio in ensaios %}
                        <tr>
                            <td>{{ ensaio.id_ensaio }}</td>
                            <td>{{ ensaio.massa.descricao }}</td>
                            <td>{{ ensaio.lote }} / {{ ensaio.batch if ensaio.batch else 'N/A' }}</td>
                            <td>
                                {{ "%.1f"|format(ensaio.valores_medidos.get('Viscosidade', 0)) }}
                                <span class="badge bg-secondary" style="font-size: 0.7em;">{{ ensaio.origem_viscosidade }}</span>
                            </td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar 
                                        {% if ensaio.score_final >= 85 %}bg-success
                                        {% elif ensaio.score_final >= 70 %}bg-warning
                                        {% else %}bg-danger{% endif %}" 
                                        role="progressbar" 
                                        style="width: {{ ensaio.score_final }}%;" 
                                        aria-valuenow="{{ ensaio.score_final }}" 
                                        aria-valuemin="0" 
                                        aria-valuemax="100">
                                        {{ "%.1f"|format(ensaio.score_final) }}%
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge 
                                    {% if 'PRIME' in ensaio.acao_recomendada %}bg-success
                                    {% elif 'LIBERAR' == ensaio.acao_recomendada %}bg-success
                                    {% elif 'RESSALVA' in ensaio.acao_recomendada %}bg-warning text-dark
                                    {% elif 'CORTAR' in ensaio.acao_recomendada %}bg-dark
                                    {% else %}bg-danger{% endif %}">
                                    {{ ensaio.acao_recomendada }}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-primary btn-detalhes" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#detailsModal"
                                        data-id="{{ ensaio.id_ensaio }}"
                                        data-lote="{{ ensaio.lote }}"
                                        data-batch="{{ ensaio.batch }}"
                                        data-material="{{ ensaio.massa.descricao }}"
                                        data-score="{{ '%.1f'|format(ensaio.score_final) }}"

                                        data-ts2-target=" {{ ensaio.massa.parametros.Ts2.alvo }} seg"
                                        data-ts2-measured="{{ ensaio.valores_medidos.Ts2 }} seg"
                                        data-ts2-status="{{ 'danger' if ensaio.ts2_fora else 'success' }}"

                                        data-t90-target="{{ ensaio.massa.parametros.T90.alvo }} seg"
                                        data-t90-measured="{{ ensaio.valores_medidos.T90 }} seg"
                                        data-t90-status="{{ 'danger' if ensaio.t90_fora else 'success' }}"

                                        data-ml-target=" {{ ensaio.massa.parametros.Viscosidade.alvo }} dNm"
                                        data-ml-measured="{{ ensaio.valores_medidos.Viscosidade }} dNm"
                                        data-ml-status="dark"

                                        data-detalhes="{{ ' || '.join(ensaio.detalhes_score) }}">
                                    <i class="fas fa-eye"></i>
                                </button>

                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

             <!-- Paginação -->
             <nav aria-label="Navegação" class="mt-3">
                <ul class="pagination justify-content-end">
                    <li class="page-item disabled"><a class="page-link" href="#">Anterior</a></li>
                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                    <li class="page-item"><a class="page-link" href="#">Próximo</a></li>
                </ul>
            </nav>

        </div> <!-- /Container -->
    </div> <!-- /Page Content -->
</div> <!-- /Wrapper -->

<!-- Modal de Detalhes -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title"><i class="fas fa-microscope me-2"></i> Detalhes do Ensaio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body">
                <div class="mb-3 text-center">
                    <h4 id="modalBatchDisplay" class="fw-bold">--</h4>
                    <p class="text-muted mb-0" id="modalMaterialDisplay">--</p>
                </div>
                
                <hr>
                <h6 class="text-secondary small fw-bold mb-3">PARÂMETROS MEDIDOS</h6>
                
                <div class="row mb-2 border-bottom pb-1">
                    <div class="col-4 fw-bold text-secondary">Ts2 (Scorch):</div>
                    <div class="col-8">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted small">Alvo: <span id="ts2Target">--</span></span>
                            <span id="ts2Measured" class="fw-bold">--</span>
                        </div>
                    </div>
                </div>

                <div class="row mb-2 border-bottom pb-1">
                    <div class="col-4 fw-bold text-secondary">T90 (Cura):</div>
                    <div class="col-8">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted small">Alvo: <span id="t90Target">--</span></span>
                            <span id="t90Measured" class="fw-bold">--</span>
                        </div>
                    </div>
                </div>

                <div class="row mb-2 border-bottom pb-1">
                    <div class="col-4 fw-bold text-secondary">Viscosidade:</div>
                    <div class="col-8">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted small">Alvo: <span id="mlTarget">--</span></span>
                            <span id="mlMeasured" class="fw-bold">--</span>
                        </div>
                    </div>
                </div>

                <div class="alert alert-light border mt-4 mb-0 small text-center">
                    Quality Score Final: <strong id="modalScoreDisplay">--</strong>%
                </div>
            </div>
            
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Script Personalizado -->
<script src="{{ url_for('static', filename='script.js') }}"></script>

</body>
</html>