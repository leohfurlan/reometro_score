{% extends "base.html" %}

{% block title %}Configuração de Massas - ReoScore{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fs-4 mb-0 text-secondary"><i class="fas fa-cogs me-2"></i>Configurações de Massas</h2>
        <p class="text-muted small">Defina os parâmetros de qualidade e pesos para cálculo do Score.</p>
    </div>
    
    <a href="{{ url_for('dashboard') }}" class="btn btn-success shadow-sm">
        <i class="fas fa-check-circle me-2"></i>Salvar e Sair
    </a>
</div>

<div class="card p-3 mb-4 shadow-sm border-0">
    <form method="GET" action="/config">
        <div class="input-group">
            <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
            <input type="text" name="q" class="form-control border-start-0 ps-0" placeholder="Buscar por nome ou código..." value="{{ query }}">
            <button class="btn btn-primary" type="submit">Buscar</button>
        </div>
    </form>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-3">Cód.</th>
                        <th>Descrição</th>
                        <th>Temp. Padrão</th>
                        <th>Status</th>
                        <th class="text-end pe-3">Ação</th>
                    </tr>
                </thead>
                <tbody>
                    {% for prod in produtos %}
                    <tr>
                        <td class="ps-3 fw-bold text-muted">{{ prod.cod_sankhya }}</td>
                        <td>{{ prod.descricao }}</td>
                        <td>
                            {% if prod.temp_padrao is defined and prod.temp_padrao and prod.temp_padrao > 0 %}
                                {{ prod.temp_padrao }}°C
                            {% else %}
                                <span class="text-muted small">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if prod.parametros is defined %}
                                {% if prod.parametros %}
                                    <span class="badge bg-success bg-opacity-10 text-success border border-success">Configurado</span>
                                {% else %}
                                    <span class="badge bg-secondary bg-opacity-10 text-secondary border">Sem Specs</span>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-light text-dark border">Matéria Prima</span>
                            {% endif %}
                        </td>
                        <td class="text-end pe-3">
                            {% if prod.parametros is defined %}
                                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalEdit{{ prod.cod_sankhya }}">
                                    <i class="fas fa-edit me-1"></i> Editar
                                </button>
                            {% else %}
                                <button class="btn btn-sm btn-outline-secondary" disabled title="Edição de MP em breve">
                                    <i class="fas fa-lock me-1"></i> MP
                                </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    
                    {% if produtos|length == 0 %}
                    <tr>
                        <td colspan="5" class="text-center py-4 text-muted">
                            Nenhum produto encontrado. Tente buscar pelo nome.
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block modais %}
    {% for prod in produtos %}
        {% if prod.parametros is defined %}
        <div class="modal fade" id="modalEdit{{ prod.cod_sankhya }}" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <form action="/salvar_config" method="POST">
                    <div class="modal-content">
                        <div class="modal-header bg-light">
                            <h5 class="modal-title fw-bold">Configurar: {{ prod.descricao }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" name="cod_sankhya" value="{{ prod.cod_sankhya }}">
                            
                            <div class="alert alert-light border mb-4">
                                <label class="fw-bold mb-1 text-secondary"><i class="fas fa-temperature-high me-1"></i> Temperatura de Análise Padrão (°C)</label>
                                <input type="number" step="0.1" class="form-control w-25" name="temp_padrao" 
                                       value="{{ prod.temp_padrao if prod.temp_padrao is defined and prod.temp_padrao else '' }}" 
                                       placeholder="Ex: 180">
                            </div>

                            <h6 class="text-secondary fw-bold mb-3 border-bottom pb-2">PARÂMETROS PADRÃO</h6>
                            
                            <div class="row mb-2 fw-bold text-center small text-muted text-uppercase">
                                <div class="col-3 text-start">Parâmetro</div>
                                <div class="col-2">Peso (0-10)</div> <div class="col-2">Mínimo</div>
                                <div class="col-2">Alvo</div>
                                <div class="col-3">Máximo</div>
                            </div>

                            {% for param in ['Ts2', 'T90', 'Viscosidade'] %}
                            {% set p_val = prod.parametros.get(param) %}
                            <div class="row mb-3 align-items-center">
                                <div class="col-3 fw-bold text-secondary">{{ param }}</div>
                                
                                <div class="col-2">
                                    <input type="number" min="0" max="10" step="1" class="form-control text-center fw-bold text-primary" 
                                           name="{{ param }}_peso" 
                                           value="{{ p_val.peso if p_val else 10 }}" 
                                           required>
                                </div>

                                <div class="col-2"><input type="number" step="0.01" class="form-control text-center" name="{{ param }}_min" value="{{ p_val.minimo if p_val else '' }}"></div>
                                <div class="col-2"><input type="number" step="0.01" class="form-control text-center bg-light" name="{{ param }}_alvo" value="{{ p_val.alvo if p_val else '' }}"></div>
                                <div class="col-3"><input type="number" step="0.01" class="form-control text-center" name="{{ param }}_max" value="{{ p_val.maximo if p_val else '' }}"></div>
                            </div>
                            {% endfor %}

                            <div class="mt-4">
                                <h6 class="text-secondary fw-bold mb-3 border-bottom pb-2 d-flex justify-content-between align-items-center">
                                    OUTROS PARÂMETROS
                                    <button type="button" class="btn btn-sm btn-outline-success" onclick="addParamRow('containerParams{{ prod.cod_sankhya }}')">
                                        <i class="fas fa-plus"></i> Novo Parâmetro
                                    </button>
                                </h6>
                                
                                <div id="containerParams{{ prod.cod_sankhya }}">
                                    {% for nome, p in prod.parametros.items() %}
                                        {% if nome not in ['Ts2', 'T90', 'Viscosidade'] %}
                                        <div class="row mb-2 align-items-center param-row">
                                            <div class="col-3"><input type="text" class="form-control form-control-sm fw-bold" name="din_nome[]" value="{{ nome }}"></div>
                                            
                                            <div class="col-2">
                                                <input type="number" min="0" max="10" step="1" class="form-control form-control-sm text-center fw-bold text-primary" 
                                                       name="din_peso[]" value="{{ p.peso }}">
                                            </div>

                                            <div class="col-2"><input type="number" step="0.01" class="form-control form-control-sm text-center" name="din_min[]" value="{{ p.minimo }}"></div>
                                            <div class="col-2"><input type="number" step="0.01" class="form-control form-control-sm text-center bg-light" name="din_alvo[]" value="{{ p.alvo }}"></div>
                                            <div class="col-3 d-flex gap-1">
                                                <input type="number" step="0.01" class="form-control form-control-sm text-center" name="din_max[]" value="{{ p.maximo }}">
                                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.param-row').remove()"><i class="fas fa-times"></i></button>
                                            </div>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>

                        </div>
                        <div class="modal-footer bg-light">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary px-4 fw-bold">Salvar Configuração</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
    {% endfor %}

    <script>
    function addParamRow(containerId) {
        const container = document.getElementById(containerId);
        const html = `
        <div class="row mb-2 align-items-center param-row">
            <div class="col-3"><input type="text" class="form-control form-control-sm" name="din_nome[]" placeholder="Nome" required></div>
            <div class="col-2"><input type="number" min="0" max="10" step="1" class="form-control form-control-sm text-center fw-bold text-primary" name="din_peso[]" value="5"></div>
            <div class="col-2"><input type="number" step="0.01" class="form-control form-control-sm text-center" name="din_min[]" placeholder="Min"></div>
            <div class="col-2"><input type="number" step="0.01" class="form-control form-control-sm text-center bg-light" name="din_alvo[]" placeholder="Alvo"></div>
            <div class="col-3 d-flex gap-1">
                <input type="number" step="0.01" class="form-control form-control-sm text-center" name="din_max[]" placeholder="Max">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.param-row').remove()"><i class="fas fa-times"></i></button>
            </div>
        </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
    }
    </script>
{% endblock %}