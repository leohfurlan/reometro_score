{% extends "base.html" %}

{% block title %}Configuração de Massas - ReoScore{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fs-4 mb-0 text-secondary"><i class="fas fa-cogs me-2"></i>Configurações de Massas</h2>
        <p class="text-muted small">Defina os parâmetros de qualidade e pesos para cálculo do Score.</p>
    </div>
    
    <a href="{{ url_for('dashboard') }}" class="btn btn-success shadow-sm">
        <i class="fas fa-check-circle me-2"></i>Salvar e Sair
    </a>
</div>

<div class="card p-3 mb-4 shadow-sm border-0">
    <form method="GET" action="/config">
        <div class="input-group">
            <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
            <input type="text" name="q" class="form-control border-start-0 ps-0" placeholder="Buscar por nome ou código..." value="{{ query }}">
            <button class="btn btn-primary" type="submit">Buscar</button>
        </div>
    </form>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-3">Cód.</th>
                        <th>Descrição</th>
                        <th>Perfis Ativos</th>
                        <th>Status</th>
                        <th class="text-end pe-3">Ação</th>
                    </tr>
                </thead>
                <tbody>
                    {% for prod in produtos %}
                    <tr>
                        <td class="ps-3 fw-bold text-muted">{{ prod.cod_sankhya }}</td>
                        <td>{{ prod.descricao }}</td>
                        <td>
                            {% if prod.perfis is defined %}
                                {% if prod.perfis.get('alta') %}
                                    <span class="badge bg-danger bg-opacity-10 text-danger border border-danger me-1">Alta</span>
                                {% endif %}
                                {% if prod.perfis.get('baixa') %}
                                    <span class="badge bg-primary bg-opacity-10 text-primary border border-primary">Baixa</span>
                                {% endif %}
                                {% if not prod.perfis.get('alta') and not prod.perfis.get('baixa') %}
                                    <span class="text-muted small">-</span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted small">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if prod.parametros is defined or prod.perfis is defined %}
                                <span class="badge bg-success bg-opacity-10 text-success border border-success">Configurado</span>
                            {% else %}
                                <span class="badge bg-secondary bg-opacity-10 text-secondary border">Sem Specs</span>
                            {% endif %}
                        </td>
                        <td class="text-end pe-3">
                            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalEdit{{ prod.cod_sankhya }}">
                                <i class="fas fa-edit me-1"></i> Editar
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                    
                    {% if produtos|length == 0 %}
                    <tr>
                        <td colspan="5" class="text-center py-4 text-muted">
                            Nenhum produto encontrado. Tente buscar pelo nome.
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block modais %}
    {% for prod in produtos %}
        <div class="modal fade" id="modalEdit{{ prod.cod_sankhya }}" tabindex="-1">
            <div class="modal-dialog modal-xl"> <form action="/salvar_config" method="POST">
                    <div class="modal-content">
                        <div class="modal-header bg-light">
                            <h5 class="modal-title fw-bold">Configurar: {{ prod.descricao }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" name="cod_sankhya" value="{{ prod.cod_sankhya }}">
                            
                            <h6 class="text-secondary fw-bold mb-3 border-bottom pb-2">PERFIS DE TEMPERATURA</h6>

                            <div class="row g-4">
                                {% set perfis = prod.perfis if prod.perfis is defined else {} %}
                                {% set perfis_alta = perfis.get('alta', {}) %}
                                {% set perfis_baixa = perfis.get('baixa', {}) %}

                                <div class="col-md-6 border-end">
                                    <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-danger bg-opacity-10 rounded">
                                        <h6 class="text-danger fw-bold mb-0"><i class="fas fa-fire me-2"></i>Alta Temp. (Batch)</h6>
                                        <div class="input-group input-group-sm" style="width: 160px;">
                                            <span class="input-group-text border-0 bg-transparent text-muted small">Padrão:</span>
                                            <input type="number" step="0.1" name="alta_temp_padrao" class="form-control fw-bold text-center" 
                                                   value="{{ perfis_alta.get('temp_padrao', '') }}" placeholder="Ex: 190">
                                            <span class="input-group-text border-0 bg-transparent text-muted small">°C</span>
                                        </div>
                                    </div>

                                    <div class="row g-1 mb-2 text-center text-muted x-small fw-bold" style="font-size: 0.75rem;">
                                        <div class="col-3 text-start ps-2">Parâmetro</div>
                                        <div class="col-2">Min</div>
                                        <div class="col-2">Alvo</div>
                                        <div class="col-2">Max</div>
                                        <div class="col-3">Peso Score</div>
                                    </div>

                                    {% for param in ['Ts2', 'T90', 'Viscosidade'] %}
                                    {% set p_val = perfis_alta.get(param) if perfis_alta else None %}
                                    <div class="row g-1 mb-2 align-items-center">
                                        <div class="col-3">
                                            <label class="form-label mb-0 fw-bold text-secondary small ps-1">{{ param }}</label>
                                        </div>
                                        <div class="col-2">
                                            <input type="number" step="0.01" name="alta_{{ param }}_min" class="form-control form-control-sm text-center" 
                                                   value="{{ p_val.minimo if p_val else '' }}">
                                        </div>
                                        <div class="col-2">
                                            <input type="number" step="0.01" name="alta_{{ param }}_alvo" class="form-control form-control-sm text-center fw-bold bg-light" 
                                                   value="{{ p_val.alvo if p_val else '' }}">
                                        </div>
                                        <div class="col-2">
                                            <input type="number" step="0.01" name="alta_{{ param }}_max" class="form-control form-control-sm text-center" 
                                                   value="{{ p_val.maximo if p_val else '' }}">
                                        </div>
                                        <div class="col-3">
                                            <input type="number" min="0" max="10" step="1" name="alta_{{ param }}_peso" class="form-control form-control-sm text-center text-primary fw-bold" 
                                                   value="{{ p_val.peso if p_val else 10 }}">
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>

                                <div class="col-md-6">
                                    <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-primary bg-opacity-10 rounded">
                                        <h6 class="text-primary fw-bold mb-0"><i class="fas fa-snowflake me-2"></i>Baixa Temp. (Mistura)</h6>
                                        <div class="input-group input-group-sm" style="width: 160px;">
                                            <span class="input-group-text border-0 bg-transparent text-muted small">Padrão:</span>
                                            <input type="number" step="0.1" name="baixa_temp_padrao" class="form-control fw-bold text-center" 
                                                   value="{{ perfis_baixa.get('temp_padrao', '') }}" placeholder="Ex: 150">
                                            <span class="input-group-text border-0 bg-transparent text-muted small">°C</span>
                                        </div>
                                    </div>

                                    <div class="row g-1 mb-2 text-center text-muted x-small fw-bold" style="font-size: 0.75rem;">
                                        <div class="col-3 text-start ps-2">Parâmetro</div>
                                        <div class="col-2">Min</div>
                                        <div class="col-2">Alvo</div>
                                        <div class="col-2">Max</div>
                                        <div class="col-3">Peso Score (0 a 10)</div>
                                    </div>

                                    {% for param in ['Ts2', 'T90', 'Viscosidade'] %}
                                    {% set p_val = perfis_baixa.get(param) if perfis_baixa else None %}
                                    <div class="row g-1 mb-2 align-items-center">
                                        <div class="col-3">
                                            <label class="form-label mb-0 fw-bold text-secondary small ps-1">{{ param }}</label>
                                        </div>
                                        <div class="col-2">
                                            <input type="number" step="0.01" name="baixa_{{ param }}_min" class="form-control form-control-sm text-center" 
                                                   value="{{ p_val.minimo if p_val else '' }}">
                                        </div>
                                        <div class="col-2">
                                            <input type="number" step="0.01" name="baixa_{{ param }}_alvo" class="form-control form-control-sm text-center fw-bold bg-light" 
                                                   value="{{ p_val.alvo if p_val else '' }}">
                                        </div>
                                        <div class="col-2">
                                            <input type="number" step="0.01" name="baixa_{{ param }}_max" class="form-control form-control-sm text-center" 
                                                   value="{{ p_val.maximo if p_val else '' }}">
                                        </div>
                                        <div class="col-3">
                                            <input type="number" min="0" max="10" step="1" name="baixa_{{ param }}_peso" class="form-control form-control-sm text-center text-primary fw-bold" 
                                                   value="{{ p_val.peso if p_val else 10 }}">
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="mt-4">
                                <h6 class="text-secondary fw-bold mb-3 border-bottom pb-2 d-flex justify-content-between align-items-center">
                                    <span><i class="fas fa-list me-2"></i>PARÂMETROS DINÂMICOS (LEGACY)</span>
                                    <button type="button" class="btn btn-sm btn-outline-success" onclick="addParamRow('containerParams{{ prod.cod_sankhya }}')">
                                        <i class="fas fa-plus"></i> Novo
                                    </button>
                                </h6>
                                
                                <div id="containerParams{{ prod.cod_sankhya }}">
                                    <div class="row g-1 mb-2 text-center text-muted x-small fw-bold" style="font-size: 0.75rem;">
                                        <div class="col-3 text-start">Nome</div>
                                        <div class="col-2">Peso</div>
                                        <div class="col-2">Min</div>
                                        <div class="col-2">Alvo</div>
                                        <div class="col-3">Max</div>
                                    </div>

                                    {% for nome, p in prod.parametros.items() %}
                                        {% if nome not in ['Ts2', 'T90', 'Viscosidade'] %}
                                        <div class="row mb-2 align-items-center param-row">
                                            <div class="col-3"><input type="text" class="form-control form-control-sm fw-bold" name="din_nome[]" value="{{ nome }}"></div>
                                            <div class="col-2"><input type="number" min="0" max="10" step="1" class="form-control form-control-sm text-center fw-bold text-primary" name="din_peso[]" value="{{ p.peso }}"></div>
                                            <div class="col-2"><input type="number" step="0.01" class="form-control form-control-sm text-center" name="din_min[]" value="{{ p.minimo }}"></div>
                                            <div class="col-2"><input type="number" step="0.01" class="form-control form-control-sm text-center bg-light" name="din_alvo[]" value="{{ p.alvo }}"></div>
                                            <div class="col-3 d-flex gap-1">
                                                <input type="number" step="0.01" class="form-control form-control-sm text-center" name="din_max[]" value="{{ p.maximo }}">
                                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.param-row').remove()"><i class="fas fa-times"></i></button>
                                            </div>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>

                        </div>
                        <div class="modal-footer bg-light">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary px-4 fw-bold">Salvar Configuração</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    {% endfor %}

    <script>
    function addParamRow(containerId) {
        const container = document.getElementById(containerId);
        const html = `
        <div class="row mb-2 align-items-center param-row">
            <div class="col-3"><input type="text" class="form-control form-control-sm" name="din_nome[]" placeholder="Nome" required></div>
            <div class="col-2"><input type="number" min="0" max="10" step="1" class="form-control form-control-sm text-center fw-bold text-primary" name="din_peso[]" value="5"></div>
            <div class="col-2"><input type="number" step="0.01" class="form-control form-control-sm text-center" name="din_min[]" placeholder="Min"></div>
            <div class="col-2"><input type="number" step="0.01" class="form-control form-control-sm text-center bg-light" name="din_alvo[]" placeholder="Alvo"></div>
            <div class="col-3 d-flex gap-1">
                <input type="number" step="0.01" class="form-control form-control-sm text-center" name="din_max[]" placeholder="Max">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.param-row').remove()"><i class="fas fa-times"></i></button>
            </div>
        </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
    }
    </script>
{% endblock %}