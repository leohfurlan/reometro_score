{% extends "base.html" %}

{% block title %}Configurações do Sistema - ReoScore{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fs-4 mb-0 text-secondary"><i class="fas fa-cogs me-2"></i>Painel de Configurações</h2>
        <p class="text-muted small">Gerencie especificações de materiais e regras globais de decisão.</p>
    </div>
    
    <a href="{{ url_for('dashboard') }}" class="btn btn-success shadow-sm">
        <i class="fas fa-check-circle me-2"></i>Salvar e Sair
    </a>
</div>

<ul class="nav nav-tabs mb-4" id="configTabs" role="tablist">
    
    {% if current_user.is_admin %}
    <li class="nav-item" role="presentation">
        <button class="nav-link fw-bold active" id="materiais-tab" data-bs-toggle="tab" data-bs-target="#materiais" type="button">
            <i class="fas fa-flask me-2"></i>Materiais
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link fw-bold" id="regras-tab" data-bs-toggle="tab" data-bs-target="#regras" type="button">
            <i class="fas fa-gavel me-2"></i>Regras de Ação
        </button>
    </li>
    {% endif %}

    <li class="nav-item" role="presentation">
        <button class="nav-link fw-bold {% if not current_user.is_admin %}active{% endif %}" id="ensinar-tab" data-bs-toggle="tab" data-bs-target="#ensinar" type="button">
            <i class="fas fa-chalkboard-teacher me-2"></i>Ensinar Sistema
        </button>
    </li>
</ul>

<div class="tab-content" id="configTabsContent">
    
    {% if current_user.is_admin %}
    <div class="tab-pane fade show active" id="materiais" role="tabpanel">
        <div class="card p-4 mb-4 shadow-sm border-0">
            <form method="GET" action="/config">
                <input type="hidden" name="sort" value="{{ sort_by }}">
                <input type="hidden" name="order" value="{{ order }}">
                
                <div class="row g-3">
                    <div class="col-md-5">
                        <label class="form-label small fw-bold text-muted">Buscar Produto</label>
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                            <input type="text" name="q" class="form-control border-start-0 ps-0" placeholder="Nome ou Código..." value="{{ query }}">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-muted">Tipo de Material</label>
                        <select name="tipo" class="form-select" onchange="this.form.submit()">
                            <option value="">Todos</option>
                            <option value="MASSA" {% if filtro_tipo == 'MASSA' %}selected{% endif %}>Massas</option>
                            <option value="MATERIA_PRIMA" {% if filtro_tipo == 'MATERIA_PRIMA' %}selected{% endif %}>Matérias Primas</option>
                            <option value="DISSOLUCAO" {% if filtro_tipo == 'DISSOLUCAO' %}selected{% endif %}>Dissoluções</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-muted">Status Configuração</label>
                        <select name="status" class="form-select" onchange="this.form.submit()">
                            <option value="">Todos</option>
                            <option value="OK" {% if filtro_status == 'OK' %}selected{% endif %}>✅ Configurados</option>
                            <option value="PENDENTE" {% if filtro_status == 'PENDENTE' %}selected{% endif %}>⚠️ Pendentes (Sem Specs)</option>
                        </select>
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                        <button class="btn btn-primary w-100 fw-bold" type="submit"><i class="fas fa-filter"></i></button>
                    </div>
                </div>
                {% if query or filtro_tipo or filtro_status %}
                <div class="mt-2 text-end">
                    <a href="{{ url_for('pagina_config') }}" class="text-decoration-none small text-muted"><i class="fas fa-times me-1"></i>Limpar Filtros</a>
                </div>
                {% endif %}
            </form>
        </div>

        <div class="table-responsive shadow-sm border rounded bg-white">
            <table class="table table-striped table-hover align-middle text-nowrap mb-0">
                <thead class="bg-light sticky-top">
                    <tr>
                        {% set args = {'q': query, 'tipo': filtro_tipo, 'status': filtro_status} %}
                        <th class="resizable-col" style="width: 80px;">
                            <a href="{{ url_for('pagina_config', sort='cod', order='asc' if order=='desc' else 'desc', **args) }}" class="text-decoration-none text-secondary d-block">
                                Cód. <i class="fas fa-sort small ms-1"></i>
                            </a>
                        </th>
                        <th class="resizable-col">
                            <a href="{{ url_for('pagina_config', sort='descricao', order='asc' if order=='desc' else 'desc', **args) }}" class="text-decoration-none text-secondary d-block">
                                Descrição do Material <i class="fas fa-sort small ms-1"></i>
                            </a>
                        </th>
                        <th class="resizable-col">Perfis Ativos</th>
                        <th class="resizable-col">Status</th>
                        <th class="text-end pe-4">Ação</th>
                    </tr>
                </thead>
                <tbody>
                    {% for prod in produtos %}
                    <tr>
                        <td class="fw-bold text-muted text-center">{{ prod.cod_sankhya }}</td>
                        <td>
                            <div class="fw-bold truncate-responsive" title="{{ prod.descricao }}" style="max-width: 450px;">
                                {{ prod.descricao }}
                            </div>
                            {% if prod.tipo != 'MASSA' %}
                                <div class="text-muted small" style="font-size: 0.75em;">Tipo: {{ prod.tipo }}</div>
                            {% endif %}
                        </td>
                        <td>
                            {% if prod.perfis is defined %}
                                {% if prod.perfis.get('alta') %}<span class="badge bg-danger bg-opacity-10 text-danger border border-danger me-1">Alta</span>{% endif %}
                                {% if prod.perfis.get('baixa') %}<span class="badge bg-primary bg-opacity-10 text-primary border border-primary">Baixa</span>{% endif %}
                                {% if not prod.perfis.get('alta') and not prod.perfis.get('baixa') %}<span class="text-muted small">-</span>{% endif %}
                            {% else %}
                                <span class="text-muted small">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% set tem_alta = prod.perfis and prod.perfis.get('alta') %}
                            {% set tem_baixa = prod.perfis and prod.perfis.get('baixa') %}
                            {% set tem_params = prod.parametros and prod.parametros|length > 0 %}

                            {% if tem_alta or tem_baixa or tem_params %}
                                <span class="badge bg-success text-white"><i class="fas fa-check me-1"></i> Configurado</span>
                            {% else %}
                                <span class="badge bg-light text-secondary border">Pendente</span>
                            {% endif %}
                        </td>
                        <td class="text-end pe-3">
                            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalEdit{{ prod.cod_sankhya }}">
                                <i class="fas fa-edit me-1"></i> Editar
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                    {% if produtos|length == 0 %}
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted bg-white">
                            <i class="fas fa-search fa-2x mb-3 opacity-25"></i><br>
                            Nenhum produto encontrado.
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <div class="pagination-container d-flex justify-content-between align-items-center bg-white border border-top-0 rounded-bottom p-2 mb-5">
            <div class="small text-muted ms-2">Total: <strong>{{ total_itens_mat }}</strong> registros</div>
            {% if total_paginas_mat > 1 %}
            <nav>
                <ul class="pagination pagination-sm mb-0 align-items-center">
                    {% set args = {'q': query, 'tipo': filtro_tipo, 'status': filtro_status, 'sort': sort_by, 'order': order} %}
                    
                    <li class="page-item {% if pagina_atual_mat == 1 %}disabled{% endif %}">
                        <a class="page-link border-0" href="{{ url_for('pagina_config', page_mat=pagina_atual_mat-1, **args) }}"><i class="fas fa-angle-left"></i></a>
                    </li>
                    
                    <li class="page-item d-flex align-items-center mx-2">
                        <span class="small text-muted me-2">Pág.</span>
                        <form action="/config" method="GET" style="display:inline;">
                            {% for k, v in args.items() %}
                                <input type="hidden" name="{{ k }}" value="{{ v }}">
                            {% endfor %}
                            <input type="number" name="page_mat" class="form-control form-control-sm page-input text-center" 
                                value="{{ pagina_atual_mat }}" min="1" max="{{ total_paginas_mat }}" style="width: 50px;" onchange="this.form.submit()">
                        </form>
                        <span class="small text-muted ms-2">de {{ total_paginas_mat }}</span>
                    </li>
                    
                    <li class="page-item {% if pagina_atual_mat == total_paginas_mat %}disabled{% endif %}">
                        <a class="page-link border-0" href="{{ url_for('pagina_config', page_mat=pagina_atual_mat+1, **args) }}"><i class="fas fa-angle-right"></i></a>
                    </li>
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>

    <div class="tab-pane fade" id="regras" role="tabpanel">
        <div class="alert alert-info d-flex align-items-center small shadow-sm border-0 bg-info bg-opacity-10 text-info-emphasis">
            <i class="fas fa-info-circle fa-2x me-3 opacity-50"></i>
            <div>
                <strong>Como funciona:</strong> O sistema avalia as regras de cima para baixo (do maior Score para o menor). 
                A primeira regra que atender aos requisitos (Score mínimo atingido E condição de viscosidade) será aplicada.
            </div>
        </div>

        <div class="card shadow-sm border-0">
            <div class="card-body p-0">
                <form id="formRegras" method="POST" action="{{ url_for('salvar_regras') }}">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light text-secondary small text-uppercase">
                                <tr>
                                    <th style="width: 50px;" class="text-center">#</th>
                                    <th style="width: 25%;">Nome da Regra</th>
                                    <th style="width: 15%;" class="text-center">Score Mínimo (%)</th>
                                    <th style="width: 15%;" class="text-center">Exige Visc. Real?</th>
                                    <th style="width: 25%;">Texto da Ação (Resultado)</th>
                                    <th style="width: 15%;">Cor da Etiqueta</th>
                                    <th style="width: 50px;"></th>
                                </tr>
                            </thead>
                            <tbody id="listaRegras">
                                {% for regra in regras_acao %}
                                <tr class="regra-row">
                                    <td class="text-center text-muted fw-bold index-cell">{{ loop.index }}</td>
                                    <td>
                                        <input type="text" name="nome[]" class="form-control form-control-sm fw-bold border-0 bg-transparent" value="{{ regra.nome }}" required>
                                    </td>
                                    <td>
                                        <div class="input-group input-group-sm">
                                            <input type="number" step="0.1" min="0" max="100" name="min_score[]" class="form-control text-center fw-bold text-primary" value="{{ regra.min_score }}" required>
                                            <span class="input-group-text border-start-0 bg-white text-muted">%</span>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div class="form-check d-flex justify-content-center">
                                            <input class="form-check-input" type="checkbox" name="exige_visc_real" value="{{ loop.index0 }}" {% if regra.exige_visc_real %}checked{% endif %}>
                                        </div>
                                        <small class="text-muted x-small" style="font-size: 0.65em;">(Não aceita média)</small>
                                    </td>
                                    <td>
                                        <input type="text" name="acao[]" class="form-control form-control-sm" value="{{ regra.acao }}" required>
                                    </td>
                                    <td>
                                        <select name="cor[]" class="form-select form-select-sm border-0 bg-light">
                                            <option value="success" class="text-success fw-bold" {% if regra.cor=='success' %}selected{% endif %}>Verde (Aprovado)</option>
                                            <option value="warning" class="text-warning fw-bold" {% if regra.cor=='warning' %}selected{% endif %}>Amarelo (Atenção)</option>
                                            <option value="dark" class="text-dark fw-bold" {% if regra.cor=='dark' %}selected{% endif %}>Preto (Mistura)</option>
                                            <option value="danger" class="text-danger fw-bold" {% if regra.cor=='danger' %}selected{% endif %}>Vermelho (Reprova)</option>
                                        </select>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-outline-danger btn-sm border-0 opacity-50 hover-opacity-100" onclick="removerLinha(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="p-3 bg-light border-top text-center d-flex justify-content-between align-items-center">
                        <button type="button" class="btn btn-outline-primary btn-sm fw-bold" onclick="adicionarRegra()">
                            <i class="fas fa-plus me-1"></i> Adicionar Nova Regra
                        </button>
                        <button type="submit" class="btn btn-success btn-sm px-4 fw-bold shadow-sm">
                            <i class="fas fa-save me-2"></i> Salvar Regras de Ação
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
    <div class="tab-pane fade" id="ensinar" role="tabpanel">
    
        <div class="card mb-3 border-0 bg-light shadow-sm">
            <div class="card-body py-3">
                <form method="GET" action="{{ url_for('pagina_config') }}" class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-muted">Buscar Lote</label>
                        <input type="text" name="audit_busca" class="form-control form-control-sm" placeholder="Ex: ANTIQ..." value="{{ audit_busca }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-muted">Status</label>
                        <select name="audit_status" class="form-select form-select-sm">
                            <option value="">Problemas (Padrão)</option>
                            <option value="ALL" {% if audit_status == 'ALL' %}selected{% endif %}>-- Todos --</option>
                            <option value="MANUAL" {% if audit_status == 'MANUAL' %}selected{% endif %}>Ensinados</option>
                            <option value="FANTASMA" {% if audit_status == 'FANTASMA' %}selected{% endif %}>Fantasmas</option>
                            <option value="TEXTO" {% if audit_status == 'TEXTO' %}selected{% endif %}>Texto/Incertos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold text-muted">Data</label>
                        <input type="date" name="audit_data" class="form-control form-control-sm" value="{{ audit_data }}">
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-dark btn-sm w-100"><i class="fas fa-filter me-1"></i> Filtrar</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card shadow-sm border-0 mb-4">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-white border-bottom">
                        <tr>
                            <th class="ps-3">Data/Hora</th>
                            <th>Lote (Visualizado)</th>
                            <th>Status</th>
                            <th>Correção: Lote Real</th>
                            <th>Correção: Massa</th>
                            <th class="text-end pe-3">Ação</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ensaio in ensaios_audit %}
                        <tr class="{% if ensaio.metodo_identificacao == 'MANUAL' %}table-primary bg-opacity-10{% endif %}">
                            <td class="ps-3 small text-muted font-monospace">
                                {{ ensaio.data_hora.strftime('%d/%m %H:%M') }}
                            </td>
                            <td>
                                <div class="fw-bold text-dark user-select-all">{{ ensaio.lote }}</div>
                                <div class="x-small text-muted">Batch: {{ ensaio.batch }}</div>
                            </td>
                            <td>
                                {% if ensaio.metodo_identificacao == 'FANTASMA' %}
                                    <span class="badge bg-danger">Fantasma</span>
                                {% elif ensaio.metodo_identificacao == 'TEXTO' %}
                                    <span class="badge bg-warning text-dark">Texto</span>
                                {% elif ensaio.metodo_identificacao == 'MANUAL' %}
                                    <span class="badge bg-primary">Ensinado</span>
                                {% else %}
                                    <span class="badge bg-success">Lote OK</span>
                                {% endif %}
                            </td>
                            
                            <form action="{{ url_for('salvar_correcao') }}" method="POST">
                                <input type="hidden" name="lote_original_key" value="{{ ensaio.lote_original or ensaio.lote }}">
                                <td>
                                    <input type="text" name="novo_lote" class="form-control form-control-sm fw-bold text-primary" 
                                        value="{{ ensaio.lote }}" placeholder="Ex: 9563">
                                </td>
                                <td>
                                    <select name="massa" class="form-select form-select-sm" required>
                                        <option value="" disabled {% if not ensaio.massa %}selected{% endif %}>Selecione...</option>
                                        {% for mat in materiais_audit %}
                                            <option value="{{ mat.descricao }}" {% if ensaio.massa and ensaio.massa.descricao == mat.descricao %}selected{% endif %}>
                                                {{ mat.descricao }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td class="text-end pe-3">
                                    <button type="submit" class="btn btn-success btn-sm shadow-sm" title="Salvar">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </td>
                            </form>
                        </tr>
                        {% else %}
                        <tr><td colspan="6" class="text-center py-4 text-muted">Nenhum registro para auditar.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if total_paginas_audit > 1 %}
            <div class="card-footer bg-white py-2">
                <nav>
                    <ul class="pagination pagination-sm justify-content-center mb-0">
                        <li class="page-item {% if pagina_atual_audit == 1 %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('pagina_config', page_audit=pagina_atual_audit-1, audit_busca=audit_busca, audit_status=audit_status, audit_data=audit_data, _anchor='ensinar') }}">Anterior</a>
                        </li>
                        <li class="page-item disabled"><span class="page-link">{{ pagina_atual_audit }} / {{ total_paginas_audit }}</span></li>
                        <li class="page-item {% if pagina_atual_audit == total_paginas_audit %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('pagina_config', page_audit=pagina_atual_audit+1, audit_busca=audit_busca, audit_status=audit_status, audit_data=audit_data, _anchor='ensinar') }}">Próximo</a>
                        </li>
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>
    </div>

</div>

{% endblock %}

{% block modais %}
    {% for prod in produtos %}
        <div class="modal fade" id="modalEdit{{ prod.cod_sankhya }}" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <form action="/salvar_config" method="POST">
                    <div class="modal-content">
                        <div class="modal-header bg-light">
                            <div>
                                <h5 class="modal-title fw-bold"><i class="fas fa-sliders-h me-2 text-primary"></i>Configurar Specs</h5>
                                <div class="text-muted small">{{ prod.descricao }} (Cód: {{ prod.cod_sankhya }})</div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        
                        <div class="modal-body bg-light bg-opacity-10">
                            <input type="hidden" name="cod_sankhya" value="{{ prod.cod_sankhya }}">
                            
                            <div class="card mb-3 border-danger border-opacity-25 shadow-sm">
                                <div class="card-header bg-danger bg-opacity-10 text-danger fw-bold">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span><i class="fas fa-fire me-2"></i>Alta Temperatura (Cura/Batch)</span>
                                        <span class="badge bg-white text-danger border border-danger">Pesos Compartilhados</span>
                                    </div>
                                    
                                    <div class="row g-2 align-items-center text-dark small">
                                        <div class="col-6 border-end border-danger border-opacity-25 pe-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="fw-bold text-secondary"><i class="fas fa-robot me-1"></i>CINZA</span>
                                                <div class="d-flex gap-1">
                                                    <input type="number" step="1" name="alta_cinza_temp_padrao" class="form-control form-control-sm text-center p-0" 
                                                        style="width: 40px;" placeholder="°C" value="{{ prod.perfis.get('alta_cinza', {}).get('temp_padrao', '') }}">
                                                    <input type="number" step="1" name="alta_cinza_tempo_total" class="form-control form-control-sm text-center p-0" 
                                                        style="width: 40px;" placeholder="s" value="{{ prod.perfis.get('alta_cinza', {}).get('tempo_total', '') }}">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6 ps-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="fw-bold text-dark"><i class="fas fa-robot me-1"></i>PRETO</span>
                                                <div class="d-flex gap-1">
                                                    <input type="number" step="1" name="alta_preto_temp_padrao" class="form-control form-control-sm text-center p-0" 
                                                        style="width: 40px;" placeholder="°C" value="{{ prod.perfis.get('alta_preto', {}).get('temp_padrao', '') }}">
                                                    <input type="number" step="1" name="alta_preto_tempo_total" class="form-control form-control-sm text-center p-0" 
                                                        style="width: 40px;" placeholder="s" value="{{ prod.perfis.get('alta_preto', {}).get('tempo_total', '') }}">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="card-body p-2">
                                    <div class="row g-0 fw-bold text-muted x-small text-center mb-1 border-bottom pb-1">
                                        <div class="col-2 text-start ps-1">Parâmetro</div>
                                        <div class="col-4 bg-secondary bg-opacity-10 rounded-start"><span class="text-secondary">CINZA (Min/Alvo/Max)</span></div>
                                        <div class="col-2 border-start border-end">Peso</div>
                                        <div class="col-4 bg-dark bg-opacity-10 rounded-end"><span class="text-dark">PRETO (Min/Alvo/Max)</span></div>
                                    </div>

                                    {% set p_cinza = prod.perfis.get('alta_cinza', {}) %}
                                    {% set p_preto = prod.perfis.get('alta_preto', {}) %}
                                    
                                    {% if not p_cinza and prod.perfis.get('alta') %}
                                        {% set p_cinza = prod.perfis.get('alta') %}
                                    {% endif %}

                                    {% for param in ['Ts2', 'T90', 'Viscosidade'] %}
                                        {% set val_c = p_cinza.get(param) %}
                                        {% set val_p = p_preto.get(param) %}
                                        {% set peso_atual = val_c.peso if val_c else (val_p.peso if val_p else 10) %}

                                        <div class="row g-0 mb-2 align-items-center border-bottom pb-1">
                                            <div class="col-2 fw-bold text-secondary ps-1 small">{{ param }}</div>
                                            
                                            <div class="col-4 d-flex gap-1 px-1 bg-secondary bg-opacity-10 py-1">
                                                <input type="number" step="0.01" class="form-control form-control-sm text-center p-0" name="alta_cinza_{{ param }}_min" value="{{ val_c.minimo if val_c else '' }}" placeholder="Min">
                                                <input type="number" step="0.01" class="form-control form-control-sm text-center p-0 fw-bold" name="alta_cinza_{{ param }}_alvo" value="{{ val_c.alvo if val_c else '' }}" placeholder="Alvo">
                                                <input type="number" step="0.01" class="form-control form-control-sm text-center p-0" name="alta_cinza_{{ param }}_max" value="{{ val_c.maximo if val_c else '' }}" placeholder="Max">
                                            </div>

                                            <div class="col-2 px-1 text-center">
                                                <input type="number" min="0" max="10" class="form-control form-control-sm text-center text-primary fw-bold" name="alta_{{ param }}_peso" value="{{ peso_atual }}">
                                            </div>

                                            <div class="col-4 d-flex gap-1 px-1 bg-dark bg-opacity-10 py-1">
                                                <input type="number" step="0.01" class="form-control form-control-sm text-center p-0" name="alta_preto_{{ param }}_min" value="{{ val_p.minimo if val_p else '' }}" placeholder="Min">
                                                <input type="number" step="0.01" class="form-control form-control-sm text-center p-0 fw-bold" name="alta_preto_{{ param }}_alvo" value="{{ val_p.alvo if val_p else '' }}" placeholder="Alvo">
                                                <input type="number" step="0.01" class="form-control form-control-sm text-center p-0" name="alta_preto_{{ param }}_max" value="{{ val_p.maximo if val_p else '' }}" placeholder="Max">
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <div class="card mb-3 border-primary border-opacity-25 shadow-sm">
                                <div class="card-header bg-primary bg-opacity-10 text-primary fw-bold d-flex justify-content-between">
                                    <span><i class="fas fa-snowflake me-2"></i>Baixa Temperatura (Mistura)</span>
                                    {% set perfis_baixa = prod.perfis.get('baixa', {}) if prod.perfis else {} %}
                                    <div class="d-flex gap-2 align-items-center">
                                        <small class="text-dark">Ref:</small>
                                        <input type="number" step="1" name="baixa_temp_padrao" class="form-control form-control-sm border-0 bg-white" 
                                               style="width: 70px;" placeholder="°C" value="{{ perfis_baixa.get('temp_padrao', '') }}">
                                        <small class="text-dark">Tempo:</small>
                                        <input type="number" step="1" name="baixa_tempo_total" class="form-control form-control-sm border-0 bg-white" 
                                               style="width: 70px;" placeholder="s" value="{{ perfis_baixa.get('tempo_total', '') }}">
                                    </div>
                                </div>
                                <div class="card-body p-2">
                                    <div class="row g-1 fw-bold text-muted x-small text-center mb-1">
                                        <div class="col-3 text-start ps-3">Parâmetro</div>
                                        <div class="col-2">Mín</div>
                                        <div class="col-2">Alvo</div>
                                        <div class="col-2">Máx</div>
                                        <div class="col-3">Peso (0-10)</div>
                                    </div>
                                    {% for param in ['Ts2', 'T90', 'Viscosidade'] %}
                                    {% set p_val = perfis_baixa.get(param) %}
                                    <div class="row g-1 mb-2 align-items-center">
                                        <div class="col-3 ps-3 fw-bold text-secondary">{{ param }}</div>
                                        <div class="col-2"><input type="number" step="0.01" class="form-control form-control-sm text-center" name="baixa_{{ param }}_min" value="{{ p_val.minimo if p_val else '' }}"></div>
                                        <div class="col-2"><input type="number" step="0.01" class="form-control form-control-sm text-center bg-warning bg-opacity-10 fw-bold" name="baixa_{{ param }}_alvo" value="{{ p_val.alvo if p_val else '' }}"></div>
                                        <div class="col-2"><input type="number" step="0.01" class="form-control form-control-sm text-center" name="baixa_{{ param }}_max" value="{{ p_val.maximo if p_val else '' }}"></div>
                                        <div class="col-3"><input type="number" min="0" max="10" class="form-control form-control-sm text-center text-primary fw-bold" name="baixa_{{ param }}_peso" value="{{ p_val.peso if p_val else 10 }}"></div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer bg-light">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-success fw-bold px-4">Salvar Alterações</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    {% endfor %}

    <script>
        // Funções para a aba de Regras
        function removerLinha(btn) {
            const row = btn.closest('tr');
            if(document.querySelectorAll('.regra-row').length > 1) {
                row.remove();
                reindexar();
            } else {
                alert("É necessário ter pelo menos uma regra padrão.");
            }
        }

        function reindexar() {
            const rows = document.querySelectorAll('.regra-row');
            rows.forEach((row, index) => {
                row.querySelector('.index-cell').textContent = index + 1;
                // Importante: atualiza o value do checkbox para manter sincronia
                row.querySelector('input[type="checkbox"]').value = index;
            });
        }

        function adicionarRegra() {
            const tbody = document.getElementById('listaRegras');
            const index = tbody.querySelectorAll('tr').length;
            
            const html = `
            <tr class="regra-row">
                <td class="text-center text-muted fw-bold index-cell">${index + 1}</td>
                <td><input type="text" name="nome[]" class="form-control form-control-sm fw-bold border-0 bg-transparent" placeholder="Nova Regra"></td>
                <td>
                    <div class="input-group input-group-sm">
                        <input type="number" step="0.1" name="min_score[]" class="form-control text-center fw-bold text-primary" value="0">
                        <span class="input-group-text border-start-0 bg-white text-muted">%</span>
                    </div>
                </td>
                <td class="text-center">
                    <div class="form-check d-flex justify-content-center">
                        <input class="form-check-input" type="checkbox" name="exige_visc_real" value="${index}">
                    </div>
                </td>
                <td><input type="text" name="acao[]" class="form-control form-control-sm" value="NOVA AÇÃO"></td>
                <td>
                    <select name="cor[]" class="form-select form-select-sm border-0 bg-light">
                        <option value="success" class="text-success fw-bold">Verde</option>
                        <option value="warning" class="text-warning fw-bold">Amarelo</option>
                        <option value="dark" class="text-dark fw-bold">Preto</option>
                        <option value="danger" class="text-danger fw-bold" selected>Vermelho</option>
                    </select>
                </td>
                <td>
                    <button type="button" class="btn btn-outline-danger btn-sm border-0 opacity-50 hover-opacity-100" onclick="removerLinha(this)"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
            
            tbody.insertAdjacentHTML('beforeend', html);
        }
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Se a URL tiver #ensinar, ativa a aba correspondente
            if (window.location.hash === '#ensinar') {
                const triggerEl = document.querySelector('#ensinar-tab');
                const tab = new bootstrap.Tab(triggerEl);
                tab.show();
            }
        });
    </script>
{% endblock %}