{% extends "base.html" %}

{% block title %}Regras de Ação - ReoScore{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fs-4 mb-0 text-secondary"><i class="fas fa-gavel me-2"></i>Regras de Decisão</h2>
            <p class="text-muted small">Defina o que acontece com o lote baseado no Score calculado.</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('pagina_config') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Voltar
            </a>
            <button type="submit" form="formRegras" class="btn btn-success shadow-sm">
                <i class="fas fa-save me-2"></i>Salvar Regras
            </button>
        </div>
    </div>

    <div class="alert alert-info d-flex align-items-center small">
        <i class="fas fa-info-circle fa-2x me-3"></i>
        <div>
            <strong>Como funciona:</strong> O sistema avalia as regras de cima para baixo (do maior Score para o menor). 
            A primeira regra que atender aos requisitos (Score mínimo atingido E condição de viscosidade) será aplicada.
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <form id="formRegras" method="POST" action="{{ url_for('config_regras') }}">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th style="width: 20%;">Nome da Regra</th>
                                <th style="width: 15%;" class="text-center">Score Mínimo (%)</th>
                                <th style="width: 15%;" class="text-center">Exige Visc. Real?</th>
                                <th style="width: 30%;">Texto da Ação (Resultado)</th>
                                <th style="width: 15%;">Cor da Etiqueta</th>
                                <th style="width: 50px;"></th>
                            </tr>
                        </thead>
                        <tbody id="listaRegras">
                            {% for regra in regras %}
                            <tr class="regra-row">
                                <td class="text-center text-muted fw-bold index-cell">{{ loop.index }}</td>
                                
                                <td>
                                    <input type="text" name="nome[]" class="form-control form-control-sm fw-bold" value="{{ regra.nome }}" required>
                                </td>
                                
                                <td>
                                    <div class="input-group input-group-sm">
                                        <input type="number" step="0.1" min="0" max="100" name="min_score[]" class="form-control text-center fw-bold text-primary" value="{{ regra.min_score }}" required>
                                        <span class="input-group-text">%</span>
                                    </div>
                                </td>
                                
                                <td class="text-center">
                                    <div class="form-check d-flex justify-content-center">
                                        {# O value aqui é o índice do loop (0-based) para sabermos qual foi marcado no backend #}
                                        <input class="form-check-input" type="checkbox" name="exige_visc_real" value="{{ loop.index0 }}" {% if regra.exige_visc_real %}checked{% endif %}>
                                    </div>
                                    <small class="text-muted" style="font-size: 0.65em;">(Não aceita média)</small>
                                </td>
                                
                                <td>
                                    <input type="text" name="acao[]" class="form-control form-control-sm" value="{{ regra.acao }}" required>
                                </td>
                                
                                <td>
                                    <select name="cor[]" class="form-select form-select-sm">
                                        <option value="success" class="text-success fw-bold" {% if regra.cor=='success' %}selected{% endif %}>Verde (Aprovado)</option>
                                        <option value="warning" class="text-warning fw-bold" {% if regra.cor=='warning' %}selected{% endif %}>Amarelo (Atenção)</option>
                                        <option value="dark" class="text-dark fw-bold" {% if regra.cor=='dark' %}selected{% endif %}>Preto (Mistura)</option>
                                        <option value="danger" class="text-danger fw-bold" {% if regra.cor=='danger' %}selected{% endif %}>Vermelho (Reprova)</option>
                                    </select>
                                </td>
                                
                                <td>
                                    <button type="button" class="btn btn-outline-danger btn-sm border-0" onclick="removerLinha(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="p-3 bg-light border-top text-center">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="adicionarRegra()">
                        <i class="fas fa-plus me-1"></i> Adicionar Nova Regra
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function removerLinha(btn) {
        const row = btn.closest('tr');
        // Não deixa remover se só tiver 1
        if(document.querySelectorAll('.regra-row').length > 1) {
            row.remove();
            reindexar();
        } else {
            alert("É necessário ter pelo menos uma regra padrão (ex: Reprovação).");
        }
    }

    function reindexar() {
        const rows = document.querySelectorAll('.regra-row');
        rows.forEach((row, index) => {
            // Atualiza número visual
            row.querySelector('.index-cell').textContent = index + 1;
            // Atualiza value do checkbox para bater com o novo índice
            row.querySelector('input[type="checkbox"]').value = index;
        });
    }

    function adicionarRegra() {
        const tbody = document.getElementById('listaRegras');
        const index = tbody.querySelectorAll('tr').length;
        
        const html = `
        <tr class="regra-row">
            <td class="text-center text-muted fw-bold index-cell">${index + 1}</td>
            <td><input type="text" name="nome[]" class="form-control form-control-sm fw-bold" placeholder="Nova Regra"></td>
            <td>
                <div class="input-group input-group-sm">
                    <input type="number" step="0.1" name="min_score[]" class="form-control text-center fw-bold text-primary" value="0">
                    <span class="input-group-text">%</span>
                </div>
            </td>
            <td class="text-center">
                <div class="form-check d-flex justify-content-center">
                    <input class="form-check-input" type="checkbox" name="exige_visc_real" value="${index}">
                </div>
            </td>
            <td><input type="text" name="acao[]" class="form-control form-control-sm" value="REPROVAR"></td>
            <td>
                <select name="cor[]" class="form-select form-select-sm">
                    <option value="success" class="text-success fw-bold">Verde</option>
                    <option value="warning" class="text-warning fw-bold">Amarelo</option>
                    <option value="dark" class="text-dark fw-bold">Preto</option>
                    <option value="danger" class="text-danger fw-bold" selected>Vermelho</option>
                </select>
            </td>
            <td>
                <button type="button" class="btn btn-outline-danger btn-sm border-0" onclick="removerLinha(this)"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
        
        tbody.insertAdjacentHTML('beforeend', html);
    }
</script>
{% endblock %}