<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Lote {{ lote.numero }} - Relatório</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- ESTILOS DE TELA (PADRÃO) --- */
        body { background-color: #f8f9fa; } 
        .card-kpi { border-left: 4px solid; }
        
        /* Altura padrão do gráfico na tela */
        .chart-container {
            position: relative;
            height: 300px; 
            width: 100%;
        }

        /* --- ESTILOS DE IMPRESSÃO (PAISAGEM COMPACTA) --- */
        @media print {
            /* 1. Configuração da Página */
            @page { 
                size: A4 landscape; 
                margin: 5mm; /* Margens mínimas */
            }
            
            body { 
                background-color: white !important; 
                -webkit-print-color-adjust: exact;
                zoom: 70%; /* <--- O SEGREDO: Reduz escala para caber tudo */
                font-size: 11px;
            }

            /* 2. Ocultar elementos desnecessários */
            .btn, .no-print, .sticky-top, input[type="checkbox"], ::-webkit-scrollbar { 
                display: none !important; 
            }
            
            /* 3. Ajuste dos Cards (KPIs e Gráficos) */
            .card { 
                box-shadow: none !important; 
                border: 1px solid #ccc !important; 
                break-inside: avoid;
            }
            .card-header { 
                background-color: #f0f0f0 !important; 
                color: black !important; 
                padding: 4px 8px !important;
                font-size: 12px;
            }
            .card-body { padding: 8px !important; }

            /* 4. FORÇAR O GRID DOS KPIS (Correção do problema relatado) */
            .row-kpi-print {
                display: flex !important;
                flex-wrap: nowrap !important;
                gap: 10px !important;
                margin-bottom: 10px !important;
            }
            .col-kpi-print {
                flex: 1 !important; /* Força divisão igual */
                width: 25% !important;
            }

            /* 5. FORÇAR LAYOUT PRINCIPAL (2 COLUNAS) */
            .row-main-print { 
                display: flex !important; 
                flex-wrap: nowrap !important; 
                gap: 15px;
            }
            
            /* Coluna Esquerda (Tabelas) */
            .col-left-print { 
                width: 38% !important; 
                flex: 0 0 38% !important; 
            }
            
            /* Coluna Direita (Gráficos) */
            .col-right-print { 
                width: 62% !important; 
                flex: 0 0 62% !important; 
            }

            /* 6. Gráficos Compactos na Impressão */
            .col-right-print .card-body {
                display: block !important; 
            }
            .chart-wrapper-print {
                width: 100% !important;
                height: 240px !important; /* Altura reduzida para caber na folha */
                margin-bottom: 10px;
                page-break-inside: avoid;
            }
            .chart-container { height: 210px !important; }

            /* 7. Tabelas Compactas */
            .table-responsive { overflow: visible !important; max-height: none !important; }
            .table th, .table td { padding: 2px 4px !important; font-size: 10px; }
            .table th a { text-decoration: none !important; color: black !important; pointer-events: none; }
            
            /* Força a tabela de batches a não ter scroll na impressão e mostrar tudo (vai quebrar pág se necessário) */
            #table-batches-container { max-height: none !important; }
        }
    </style>
</head>
<body class="p-4">

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
        <div>
            <h5 class="text-secondary mb-0">{{ massa.nome }}</h5>
            <h2 class="fw-bold text-dark display-6 mb-0">Lote: {{ lote.numero }}</h2>
            <p class="text-muted mb-0 small">Cód: {{ massa.cod }} | Atualizado: {{ lote.data_recente.strftime('%d/%m/%Y %H:%M') }}</p>
        </div>
        <div class="text-end">
            <button class="btn btn-outline-secondary btn-sm mb-2 no-print" onclick="window.print()">
                <i class="fas fa-print me-2"></i> Imprimir
            </button>
            
            <div class="display-4 fw-bold lh-1 {% if lote.kpi_lote.score_medio >= 85 %}text-success{% else %}text-warning{% endif %}">
                {{ "%.0f"|format(lote.kpi_lote.score_medio) }}
            </div>
            <div class="text-muted small text-uppercase fw-bold">Score Geral</div>
        </div>
    </div>

    <div class="row g-3 mb-3 row-kpi-print">
        <div class="col-md-3 col-kpi-print"> 
            <div class="card p-2 shadow-sm card-kpi border-primary h-100">
                <div class="text-muted small fw-bold text-uppercase" style="font-size: 0.75rem;">Total Ensaios</div>
                <div class="fs-2 fw-bold text-dark lh-1">{{ lote.kpi_lote.total }}</div>
            </div>
        </div>
        <div class="col-md-3 col-kpi-print">
            <div class="card p-2 shadow-sm card-kpi border-success h-100">
                <div class="text-muted small fw-bold text-uppercase" style="font-size: 0.75rem;">Aprovados</div>
                <div class="fs-2 fw-bold text-success lh-1">{{ lote.kpi_lote.aprovados }}</div>
            </div>
        </div>
        <div class="col-md-3 col-kpi-print">
            <div class="card p-2 shadow-sm card-kpi border-warning h-100">
                <div class="text-muted small fw-bold text-uppercase" style="font-size: 0.75rem;">Ressalvas</div>
                <div class="fs-2 fw-bold text-warning lh-1">{{ lote.kpi_lote.ressalvas }}</div>
            </div>
        </div>
        <div class="col-md-3 col-kpi-print">
            <div class="card p-2 shadow-sm card-kpi border-danger h-100">
                <div class="text-muted small fw-bold text-uppercase" style="font-size: 0.75rem;">Reprovados</div>
                <div class="fs-2 fw-bold text-danger lh-1">{{ lote.kpi_lote.reprovados }}</div>
            </div>
        </div>
    </div>

    <div class="row g-4 row-main-print"> 
        
        <div class="col-md-5 col-left-print">
            
            {% if lote.medias_detalhadas.tem_alta %}
            <div class="card shadow-sm border-0 mb-3 border-start border-4 border-danger">
                <div class="card-header bg-white fw-bold text-danger py-1 x-small">
                    <i class="fas fa-fire me-1"></i>MÉDIA ALTA (CURA)
                </div>
                <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0 text-center small">
                        <thead class="bg-light">
                            <tr><th>Parâm.</th><th>Mín</th><th>Alvo</th><th>Máx</th><th class="table-danger bg-opacity-10 fw-bold border-start">Real</th></tr>
                        </thead>
                        <tbody>
                            {% set ref = ensaios[0] %}
                            {% set p_alta = ref.massa.perfis.get('alta_cinza') or ref.massa.perfis.get('alta') or ref.massa.parametros %}
                            {% for param in ['Ts2', 'T90'] %}
                            {% set p_obj = p_alta.get(param) %}
                            {% if p_obj %}
                            <tr>
                                <td class="text-start ps-2 fw-bold">{{ param }}</td>
                                <td class="text-muted">{{ p_obj.minimo }}</td>
                                <td class="text-primary fw-bold">{{ p_obj.alvo }}</td>
                                <td class="text-muted">{{ p_obj.maximo }}</td>
                                <td class="fw-bold border-start fs-6 text-danger">
                                    {{ "%.2f"|format(lote.medias_detalhadas['alta_' + param.lower()]) }}
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <div class="card shadow-sm border-0 mb-3 border-start border-4 border-primary">
                <div class="card-header bg-white fw-bold text-primary py-1 x-small">
                    <i class="fas fa-snowflake me-1"></i>MÉDIA BAIXA / VISC
                </div>
                <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0 text-center small">
                        <thead class="bg-light">
                            <tr><th>Parâm.</th><th>Mín</th><th>Alvo</th><th>Máx</th><th class="table-primary bg-opacity-10 fw-bold border-start">Real</th></tr>
                        </thead>
                        <tbody>
                            {% set ref = ensaios[0] %}
                            {% set p_baixa = ref.massa.perfis.get('baixa') or ref.massa.parametros %}
                            {% set p_visc = p_baixa.get('Viscosidade') %}
                            {% if p_visc %}
                            <tr>
                                <td class="text-start ps-2 fw-bold">Visc.</td>
                                <td class="text-muted">{{ p_visc.minimo }}</td>
                                <td class="text-primary fw-bold">{{ p_visc.alvo }}</td>
                                <td class="text-muted">{{ p_visc.maximo }}</td>
                                <td class="fw-bold border-start fs-6 text-primary">
                                    {{ "%.1f"|format(lote.medias_detalhadas.visc) }}
                                </td>
                            </tr>
                            {% endif %}
                            {% for param in ['Ts2', 'T90'] %}
                            {% set p_obj = p_baixa.get(param) %}
                            {% if p_obj and lote.medias_detalhadas['baixa_' + param.lower()] > 0 %}
                            <tr>
                                <td class="text-start ps-2 fw-bold">{{ param }} (Bx)</td>
                                <td class="text-muted">{{ p_obj.minimo }}</td>
                                <td class="text-primary fw-bold">{{ p_obj.alvo }}</td>
                                <td class="text-muted">{{ p_obj.maximo }}</td>
                                <td class="fw-bold border-start fs-6 text-dark">
                                    {{ "%.2f"|format(lote.medias_detalhadas['baixa_' + param.lower()]) }}
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-header bg-white fw-bold text-secondary d-flex justify-content-between align-items-center py-2">
                    <span class="x-small"><i class="fas fa-list me-1"></i>BATCHES INDIVIDUAIS</span>
                    <button class="btn btn-sm btn-primary py-0 no-print" onclick="atualizarGraficos()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="table-responsive" id="table-batches-container" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-hover mb-0 x-small align-middle">
                        <thead class="sticky-top bg-light">
                            <tr>
                                <th class="text-center no-print" style="width: 25px;"><input type="checkbox" id="checkAll" onclick="toggleAll(this)"></th>
                                <th><a href="{{ url_for('detalhe_lote_view', cod_sankhya=massa.cod, numero_lote=lote.numero, sort='id', order='asc' if order=='desc' else 'desc') }}" class="text-secondary text-decoration-none">ID <i class="fas fa-sort"></i></a></th>
                                <th>Hora</th>
                                <th>Batch</th>
                                <th>Temp</th>
                                <th>Score</th>
                                <th class="text-center">Sts</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for e in ensaios %}
                            <tr>
                                <td class="text-center no-print">
                                    <input type="checkbox" class="batch-check" value="{{ e.id_ensaio }}" {% if loop.index <= 10 %}checked{% endif %}>
                                </td>
                                <td>{{ e.id_ensaio }}</td>
                                <td>{{ e.data_hora.strftime('%H:%M') }}</td>
                                <td class="fw-bold">{{ e.batch }}</td>
                                <td>{{ "%.0f"|format(e.temp_plato) }}°</td>
                                <td>
                                    <span class="badge {% if e.score_final >= 85 %}bg-success{% else %}bg-warning text-dark{% endif %} border px-1">
                                        {{ "%.0f"|format(e.score_final) }}
                                    </span>
                                </td>
                                <td class="text-center">
                                    {% if "PRIME" in e.acao_recomendada or "LIBERAR" == e.acao_recomendada %}
                                        <i class="fas fa-check-circle text-success"></i>
                                    {% elif "REPROVAR" in e.acao_recomendada %}
                                        <i class="fas fa-times-circle text-danger"></i>
                                    {% else %}
                                        <i class="fas fa-exclamation-circle text-warning"></i>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-7 col-right-print">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white fw-bold text-secondary d-flex justify-content-between py-2">
                    <span class="x-small"><i class="fas fa-chart-line me-1"></i>CURVAS COMPARATIVAS</span>
                    <span class="badge bg-light text-dark border no-print" id="lblCount">10 sel.</span>
                </div>
                <div class="card-body p-3 d-flex flex-column">
                    
                    <div class="chart-wrapper-print mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <h6 class="x-small text-muted fw-bold mb-0">REOMETRIA (Torque)</h6>
                            <div class="btn-group btn-group-sm no-print" role="group">
                                <input type="radio" class="btn-check" name="btnradio" id="btnAll" autocomplete="off" checked onclick="filtrarGrafico('TODOS')">
                                <label class="btn btn-outline-secondary py-0" style="font-size: 0.75rem;" for="btnAll">Tudo</label>
                                <input type="radio" class="btn-check" name="btnradio" id="btnAlta" autocomplete="off" onclick="filtrarGrafico('ALTA')">
                                <label class="btn btn-outline-danger py-0" style="font-size: 0.75rem;" for="btnAlta">Alta</label>
                                <input type="radio" class="btn-check" name="btnradio" id="btnBaixa" autocomplete="off" onclick="filtrarGrafico('BAIXA')">
                                <label class="btn btn-outline-primary py-0" style="font-size: 0.75rem;" for="btnBaixa">Baixa</label>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="chartReometria"></canvas>
                        </div>
                    </div>
                    
                    <hr class="my-2 no-print">

                    <div class="chart-wrapper-print">
                        <h6 class="x-small text-muted fw-bold mb-1 text-center">VISCOSIDADE (Mooney)</h6>
                        <div class="chart-container">
                            <canvas id="chartViscosidade"></canvas>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let chartReo = null;
    let chartVisc = null;

    function toggleAll(source) {
        document.querySelectorAll('.batch-check').forEach(cb => cb.checked = source.checked);
        atualizarGraficos();
    }

    async function atualizarGraficos() {
        const checkboxes = document.querySelectorAll('.batch-check:checked');
        const ids = Array.from(checkboxes).map(cb => cb.value).join(',');
        
        const lbl = document.getElementById('lblCount');
        if(lbl) lbl.textContent = `${checkboxes.length} sel.`;

        if (!ids) {
            if(chartReo) chartReo.clear();
            if(chartVisc) chartVisc.clear();
            return;
        }

        try {
            const response = await fetch(`/api/grafico?ids=${ids}&mode=lote`);
            const data = await response.json();

            if (data.error) { console.warn(data.error); return; }

            renderChart('chartReometria', data.reometria, 'Torque (lb.in)', 'reo');
            renderChart('chartViscosidade', data.viscosidade, 'Mooney (MU)', 'visc');

        } catch (e) { console.error("Erro API:", e); }
    }

    function renderChart(canvasId, datasets, yLabel, type) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (type === 'reo' && chartReo) chartReo.destroy();
        if (type === 'visc' && chartVisc) chartVisc.destroy();

        if (!datasets || datasets.length === 0) return;

        const newChart = new Chart(ctx, {
            type: 'line',
            data: { datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                elements: { point: { radius: 0 } },
                interaction: { mode: 'nearest', axis: 'x', intersect: false },
                plugins: { legend: { display: false }, tooltip: { enabled: true } },
                scales: {
                    x: { type: 'linear', title: {display: true, text: 'Tempo (s)'} },
                    y: { title: {display: true, text: yLabel} }
                }
            }
        });

        if (type === 'reo') chartReo = newChart;
        if (type === 'visc') chartVisc = newChart;
    }

    function filtrarGrafico(tipo) {
        if (!chartReo) return;
        chartReo.data.datasets.forEach(ds => {
            if (tipo === 'TODOS') ds.hidden = false;
            else ds.hidden = (ds.tempType !== tipo);
        });
        chartReo.update();
    }

    document.addEventListener('DOMContentLoaded', atualizarGraficos);
</script>

</body>
</html>