{% if ensaios|length == 0 %}
    <div class="text-center py-5 text-muted bg-light rounded border border-dashed">
        <i class="fas fa-search fa-3x mb-3 opacity-25"></i>
        <h5>Nenhum registro encontrado</h5>
        <a href="{{ url_for('controle_qualidade') }}" class="btn btn-sm btn-outline-secondary mt-2">Limpar Filtros</a>
    </div>
{% else %}

<div class="table-responsive">
    <table class="table table-striped table-hover align-middle text-nowrap mb-0" id="mainTable" data-current-sort="{{ sort_by }}" data-current-order="{{ order }}">
        <thead class="bg-light sticky-top">
            <tr>
                {% set filter_params = {'search': search_term, 'acao_filter': acao_filter, 'date_start': date_start, 'date_end': date_end, 'material_filter': material_filter, 'codigo_filter': codigo_filter, 'tipo_ensaio': tipo_ensaio_filter} %}
                
                <th class="text-center" style="width: 40px;">
                    <input type="checkbox" id="selectAll" onclick="toggleAllCheckboxes(this)">
                </th>

                <th class="resizable-col col-id"><a href="#" hx-get="{{ url_for('controle_qualidade', sort='id', order='asc' if order=='desc' else 'desc', page=pagina_atual, **filter_params) }}" hx-target="#tabela-container" hx-push-url="true" class="text-decoration-none text-secondary d-block sort-link" data-sort="id" data-order="{{ 'asc' if order=='desc' else 'desc' }}">ID <i class="fas fa-sort small"></i></a></th>
                <th class="resizable-col col-data"><a href="#" hx-get="{{ url_for('controle_qualidade', sort='data', order='asc' if order=='desc' else 'desc', page=pagina_atual, **filter_params) }}" hx-target="#tabela-container" hx-push-url="true" class="text-decoration-none text-secondary d-block sort-link" data-sort="data" data-order="{{ 'asc' if order=='desc' else 'desc' }}">Data <i class="fas fa-sort small"></i></a></th>
                <th class="resizable-col col-material"><a href="#" hx-get="{{ url_for('controle_qualidade', sort='material', order='asc' if order=='desc' else 'desc', page=pagina_atual, **filter_params) }}" hx-target="#tabela-container" hx-push-url="true" class="text-decoration-none text-secondary d-block sort-link" data-sort="material" data-order="{{ 'asc' if order=='desc' else 'desc' }}">Material <i class="fas fa-sort small"></i></a></th>
                <th class="resizable-col col-lote"><a href="#" hx-get="{{ url_for('controle_qualidade', sort='lote', order='asc' if order=='desc' else 'desc', page=pagina_atual, **filter_params) }}" hx-target="#tabela-container" hx-push-url="true" class="text-decoration-none text-secondary d-block sort-link" data-sort="lote" data-order="{{ 'asc' if order=='desc' else 'desc' }}">Lote/Batch <i class="fas fa-sort small"></i></a></th>
                <th class="resizable-col col-temp"><a href="#" hx-get="{{ url_for('controle_qualidade', sort='temp', order='asc' if order=='desc' else 'desc', page=pagina_atual, **filter_params) }}" hx-target="#tabela-container" hx-push-url="true" class="text-decoration-none text-secondary d-block sort-link" data-sort="temp" data-order="{{ 'asc' if order=='desc' else 'desc' }}">Temp. (°C)<i class="fas fa-sort small"></i></a></th>
                <th class="resizable-col col-ts2"><a href="#" hx-get="{{ url_for('controle_qualidade', sort='ts2', order='asc' if order=='desc' else 'desc', page=pagina_atual, **filter_params) }}" hx-target="#tabela-container" hx-push-url="true" class="text-decoration-none text-secondary d-block sort-link" data-sort="ts2" data-order="{{ 'asc' if order=='desc' else 'desc' }}">Ts2 (s)<i class="fas fa-sort small"></i></a></th>
                <th class="resizable-col col-t90"><a href="#" hx-get="{{ url_for('controle_qualidade', sort='t90', order='asc' if order=='desc' else 'desc', page=pagina_atual, **filter_params) }}" hx-target="#tabela-container" hx-push-url="true" class="text-decoration-none text-secondary d-block sort-link" data-sort="t90" data-order="{{ 'asc' if order=='desc' else 'desc' }}">T90 (s)<i class="fas fa-sort small"></i></a></th>
                <th class="resizable-col col-visc"><a href="#" hx-get="{{ url_for('controle_qualidade', sort='visc', order='asc' if order=='desc' else 'desc', page=pagina_atual, **filter_params) }}" hx-target="#tabela-container" hx-push-url="true" class="text-decoration-none text-secondary d-block sort-link" data-sort="visc" data-order="{{ 'asc' if order=='desc' else 'desc' }}">Visc. <i class="fas fa-sort small"></i></a></th>
                <th class="resizable-col col-score"><a href="#" hx-get="{{ url_for('controle_qualidade', sort='score', order='asc' if order=='desc' else 'desc', page=pagina_atual, **filter_params) }}" hx-target="#tabela-container" hx-push-url="true" class="text-decoration-none text-secondary d-block sort-link" data-sort="score" data-order="{{ 'asc' if order=='desc' else 'desc' }}">Score <i class="fas fa-sort small"></i></a></th>
                <th class="resizable-col col-acao"><a href="#" hx-get="{{ url_for('controle_qualidade', sort='acao', order='asc' if order=='desc' else 'desc', page=pagina_atual, **filter_params) }}" hx-target="#tabela-container" hx-push-url="true" class="text-decoration-none text-secondary d-block sort-link" data-sort="acao" data-order="{{ 'asc' if order=='desc' else 'desc' }}">Ação <i class="fas fa-sort small"></i></a></th>
                <th class="text-center col-ver">Ver</th>
            </tr>
        </thead>
        <tbody>
            {% for ensaio in ensaios %}
            <tr>
                <td class="text-center">
                    <input type="checkbox" class="form-check-input curve-selector" value="{{ ensaio.id_ensaio }}">
                </td>

                <td class="col-id">{{ ensaio.id_ensaio }}</td>
                <td class="col-data">{% if ensaio.data_hora %}{{ ensaio.data_hora.strftime('%d/%m/%y') }}<div class="text-muted small" style="font-size: 0.7em;">{{ ensaio.data_hora.strftime('%H:%M') }}</div>{% else %}-{% endif %}</td>
                
                <td class="col-material">
                    <div class="d-flex align-items-center">
                        <div class="me-2" style="width: 20px; text-align: center;">
                            {% if ensaio.metodo_identificacao == 'MANUAL' %}
                                <i class="fas fa-user-check text-primary" data-bs-toggle="tooltip" title="Ensinado Manualmente"></i>
                            {% elif ensaio.metodo_identificacao == 'LOTE' %}
                                <i class="fas fa-link text-success" data-bs-toggle="tooltip" title="Identificado via Lote (Confiável)"></i>
                            {% elif ensaio.metodo_identificacao == 'TEXTO' %}
                                <i class="fas fa-magic text-warning" data-bs-toggle="tooltip" title="Match por Texto/Fuzzy (Verificar)"></i>
                            {% else %}
                                <i class="fas fa-exclamation-triangle text-danger" data-bs-toggle="tooltip" title="Não Identificado / Fantasma"></i>
                            {% endif %}
                        </div>
                        <div>
                            <div class="fw-bold truncate-responsive" title="{{ ensaio.massa_descricao }}">
                                {{ ensaio.massa_descricao }}
                            </div>
                            <div class="text-muted small" style="font-size: 0.75em;">
                                Cód: {{ ensaio.cod_sankhya }}
                            </div>
                        </div>
                    </div>
                </td>

                <td class="col-lote">
                    <div class="fw-bold truncate-responsive" title="{{ ensaio.lote }}">
                        {{ ensaio.lote }}
                    </div>
                    {% if ensaio.batch %} <div class="text-muted small">Batch: {{ ensaio.batch }}</div> {% endif %}
                </td>
                <td class="col-temp">
                    {{ ensaio.temp_plato_display }}
                </td>
                
                {# Uso de .get('Chave', 0) seguro agora que corrigimos o modelo #}
                <td class="col-ts2">{{ "%.1f"|format(ensaio.valores_medidos.get('Ts2', 0)) if ensaio.valores_medidos.get('Ts2') else '--' }}</td>
                <td class="col-t90">{{ "%.1f"|format(ensaio.valores_medidos.get('T90', 0)) if ensaio.valores_medidos.get('T90') else '--' }}</td>
                
                <td class="col-visc">
                    {% set val_visc = ensaio.valores_medidos.get('Viscosidade') %}
                    {% if val_visc %}
                        {{ "%.1f"|format(val_visc) }}
                        {% if 'Média' in ensaio.origem_viscosidade %}
                            <span class="badge bg-light text-dark border ms-1" title="Média do Lote" style="font-size: 0.6em;">M</span>
                        {% endif %}
                    {% else %}
                        <span class="text-muted">--</span>
                    {% endif %}
                </td>

                <td class="col-score">
                    <div class="progress progress-responsive">
                        <div class="progress-bar {% if ensaio.score_final >= 85 %}bg-success{% elif ensaio.score_final >= 70 %}bg-warning{% else %}bg-danger{% endif %}" role="progressbar" style="width: {{ ensaio.score_final }}%;">{{ "%.0f"|format(ensaio.score_final) }}%</div>
                    </div>
                </td>
                
                <td class="col-acao">
                    <span class="badge {% if 'PRIME' in ensaio.acao_recomendada %}bg-success{% elif 'LIBERAR' == ensaio.acao_recomendada %}bg-success{% elif 'RESSALVA' in ensaio.acao_recomendada %}bg-warning text-dark{% elif 'CORTAR' in ensaio.acao_recomendada %}bg-dark{% else %}bg-danger{% endif %}" style="font-size: 0.7em;">
                        {{ ensaio.acao_recomendada }}
                    </span>
                </td>
                
                <td class="text-center col-ver">
                    <a href="{{ url_for('analise_curva', id_ensaio=ensaio.id_ensaio) }}" class="btn btn-sm btn-outline-primary py-0 px-1" title="Ver Detalhes">
                        <i class="fas fa-eye small"></i>
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="pagination-container d-flex justify-content-between align-items-center bg-white border-top p-2">
    <div class="small text-muted">
        Total: <strong>{{ total_registros_filtrados }}</strong> registros
    </div>

    <nav aria-label="Navegação">
        <ul class="pagination pagination-sm mb-0 align-items-center">
            {% set filter_params = {'search': search_term, 'acao_filter': acao_filter, 'date_start': date_start, 'date_end': date_end, 'material_filter': material_filter, 'codigo_filter': codigo_filter, 'tipo_ensaio': tipo_ensaio_filter, 'sort': sort_by, 'order': order} %}
            <li class="page-item {% if pagina_atual == 1 %}disabled{% endif %}"><a class="page-link" href="#" hx-get="{{ url_for('controle_qualidade', page=1, **filter_params) }}" hx-target="#tabela-container" hx-push-url="true"><i class="fas fa-angle-double-left"></i></a></li>
            <li class="page-item {% if pagina_atual == 1 %}disabled{% endif %}"><a class="page-link" href="#" hx-get="{{ url_for('controle_qualidade', page=pagina_atual-1, **filter_params) }}" hx-target="#tabela-container" hx-push-url="true"><i class="fas fa-angle-left"></i></a></li>
            <li class="page-item d-flex align-items-center mx-2"><span class="small text-muted me-2">Pág.</span><input type="number" class="form-control form-control-sm page-input" value="{{ pagina_atual }}" min="1" max="{{ total_paginas }}" hx-get="{{ url_for('controle_qualidade', **filter_params) }}" hx-target="#tabela-container" hx-push-url="true" hx-trigger="change, keyup delay:800ms changed" name="page"><span class="small text-muted ms-2">de {{ total_paginas }}</span></li>
            <li class="page-item {% if pagina_atual == total_paginas %}disabled{% endif %}"><a class="page-link" href="#" hx-get="{{ url_for('controle_qualidade', page=pagina_atual+1, **filter_params) }}" hx-target="#tabela-container" hx-push-url="true"><i class="fas fa-angle-right"></i></a></li>
            <li class="page-item {% if pagina_atual == total_paginas %}disabled{% endif %}"><a class="page-link" href="#" hx-get="{{ url_for('controle_qualidade', page=total_paginas, **filter_params) }}" hx-target="#tabela-container" hx-push-url="true"><i class="fas fa-angle-double-right"></i></a></li>
        </ul>
    </nav>
</div>
{% endif %}